<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>月別・農家リスト（リファクタ済み・本番構成）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Base ===== */
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; }
    * { box-sizing: border-box; }
    body { margin:18px; font-family: system-ui, -apple-system, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; color:var(--fg); background:var(--bg); }
    h1 { font-size:20px; margin:0 0 10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; margin:6px 0; }
    input, select, textarea, button { font-size:14px; padding:8px; }
    textarea { width:100%; min-height:60px; }
    button { cursor:pointer; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; margin:10px 0; }
    .bar { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); }
    .pill { background:#f3f4f6; border:1px solid var(--line); border-radius:999px; padding:2px 10px; }

    /* ===== Table ===== */
    .tablewrap { max-height:60vh; overflow:auto; border:1px solid var(--line); border-radius:10px; }
    table { width:100%; border-collapse:collapse; }
    thead th { position:sticky; top:0; background:#f8fafc; text-align:left; padding:8px; border-bottom:1px solid var(--line); }
    td { padding:8px; border-bottom:1px solid var(--line); vertical-align:top; }

    /* ===== Modal ===== */
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { width:min(680px, 92vw); background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:12px; }
    .modal header { font-weight:700; margin-bottom:8px; }
    .modal .footer { display:flex; gap:8px; justify-content:flex-end; }

    /* ===== Toast ===== */
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:8px; display:none; font-size:12px; }

    /* ===== Mobile Card-like rows (fallback) ===== */
    @media (max-width:640px){ thead { display:none; } table, tbody, tr, td { display:block; width:100%; } td { display:flex; gap:8px; } td::before { content: attr(data-label); min-width:96px; color:var(--muted); } }
  </style>
</head>
<body>
  <h1>🍇 月別・農家リスト</h1>
  <div class="bar">
    <span id="status" class="pill">準備中…</span>
    <span id="count" class="pill">件数: 0</span>
    <span id="storage" class="pill">保存: localStorage</span>
  </div>

  <!-- Filters -->
  <div class="card" aria-label="フィルター">
    <div class="row">
      <input id="q" placeholder="果物名・農園名・メモ・電話で検索" style="flex:1 1 260px" />
      <select id="fMonth" style="width:150px">
        <option value="">すべての月</option>
      </select>
      <button id="resetFilters">リセット</button>
    </div>
  </div>

  <!-- Form -->
  <div class="card" aria-label="登録フォーム">
    <div class="row">
      <input id="year" type="number" placeholder="年 (例:2025)" style="width:120px" />
      <select id="month" style="width:120px"></select>
      <input id="fruit" placeholder="果物名" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <input id="farm" placeholder="農園名" style="flex:1 1 220px" />
      <input id="phone" placeholder="電話 (例:090-1234-5678)" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="ordered" /> 発注済み</label>
    </div>
    <div class="row">
      <textarea id="note" placeholder="メモ"></textarea>
    </div>
    <div class="row">
      <button id="add">登録</button>
      <button id="wipe">全削除</button>
    </div>
  </div>

  <!-- List -->
  <div class="tablewrap" aria-label="一覧">
    <table>
      <thead><tr>
        <th style="width:70px">月</th>
        <th>果物名</th>
        <th>農園</th>
        <th>電話</th>
        <th style="width:70px">発注</th>
        <th>メモ</th>
        <th style="width:150px">操作</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Edit Modal -->
  <div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>行を編集</header>
      <div class="row">
        <input id="e_year" type="number" placeholder="年" style="width:120px" />
        <select id="e_month" style="width:120px"></select>
        <input id="e_fruit" placeholder="果物名" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <input id="e_farm" placeholder="農園名" style="flex:1 1 220px" />
        <input id="e_phone" placeholder="電話" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <label><input type="checkbox" id="e_ordered" /> 発注済み</label>
      </div>
      <div class="row"><textarea id="e_note" placeholder="メモ"></textarea></div>
      <div class="footer">
        <button id="cancelEdit">キャンセル</button>
        <button id="saveEdit">保存</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config & State =====
    const SKEY = 'mf_items_v1';
    const state = {
      items: [],
      filters: { q: '', month: '' },
      editingId: null,
    };

    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const telHref = (raw='') => {
      const cleaned = String(raw).replace(/[^+\d]/g, '');
      return cleaned ? `tel:${cleaned}` : '';
    };
    const toast = (msg) => { const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1800); };
    const setCount = (n) => $('count').textContent = `件数: ${n}`;

    // ===== Storage =====
    const store = {
      load(){ try{ const raw = localStorage.getItem(SKEY); return raw ? JSON.parse(raw) : []; }catch{ return []; } },
      save(items){ try{ localStorage.setItem(SKEY, JSON.stringify(items)); }catch(e){ console.error(e); } }
    };

    // ===== Validation =====
    function validate(payload){
      if(!payload.fruit) return '果物名は必須です';
      if(!payload.farm) return '農園名は必須です';
      if(!payload.month) return '月を選択してください';
      return '';
    }

    // ===== Rendering =====
    function rowHTML(v){
      const tel = v.phone ? `<a href="${telHref(v.phone)}">${v.phone}</a>` : '';
      return `
        <tr data-id="${v.id}">
          <td data-label="月">${v.month ?? ''}</td>
          <td data-label="果物名">${v.fruit ?? ''}</td>
          <td data-label="農園">${v.farm ?? ''}</td>
          <td data-label="電話">${tel}</td>
          <td data-label="発注">
            <input type="checkbox" data-action="toggle" ${v.ordered ? 'checked' : ''} />
          </td>
          <td data-label="メモ">${(v.note ?? '').replace(/\n/g,' ')}</td>
          <td data-label="操作">
            <button data-action="edit">編集</button>
            <button data-action="delete">削除</button>
          </td>
        </tr>`;
    }

    function applyFilters(items){
      let view = items.slice();
      if(state.filters.month) view = view.filter(v => String(v.month) === state.filters.month);
      if(state.filters.q){
        const q = state.filters.q.toLowerCase();
        view = view.filter(v => [v.fruit, v.farm, v.note, v.phone].some(x => (x||'').toLowerCase().includes(q)));
      }
      // sort: 月 -> 果物 -> 農園
      view.sort((a,b)=> (a.month||0)-(b.month||0) || (a.fruit||'').localeCompare(b.fruit||'', 'ja') || (a.farm||'').localeCompare(b.farm||'', 'ja'));
      return view;
    }

    function render(){
      const view = applyFilters(state.items);
      const tbody = $('tbody');
      tbody.innerHTML = view.map(rowHTML).join('');
      setCount(view.length);
    }

    // ===== CRUD =====
    function add(){
      const payload = {
        id: uuid(),
        year: $('year').value.trim(),
        month: Number($('month').value),
        fruit: $('fruit').value.trim(),
        farm: $('farm').value.trim(),
        phone: $('phone').value.trim(),
        ordered: $('ordered').checked,
        note: $('note').value.trim(),
      };
      const m = validate(payload); if(m){ alert(m); return; }
      state.items.push(payload); store.save(state.items); render(); toast('登録しました');
    }

    function remove(id){
      state.items = state.items.filter(x => x.id !== id);
      store.save(state.items); render(); toast('削除しました');
    }

    function openEdit(id){
      const r = state.items.find(x => x.id === id); if(!r) return;
      state.editingId = id;
      $('e_year').value = r.year || '';
      $('e_month').value = String(r.month || '');
      $('e_fruit').value = r.fruit || '';
      $('e_farm').value = r.farm || '';
      $('e_phone').value = r.phone || '';
      $('e_ordered').checked = !!r.ordered;
      $('e_note').value = r.note || '';
      $('editBackdrop').style.display = 'flex';
    }

    function closeEdit(){ state.editingId = null; $('editBackdrop').style.display = 'none'; }

    function saveEdit(){
      const id = state.editingId; if(!id) return;
      const i = state.items.findIndex(x => x.id === id); if(i < 0) return;
      const upd = {
        ...state.items[i],
        year: $('e_year').value.trim(),
        month: Number($('e_month').value),
        fruit: $('e_fruit').value.trim(),
        farm: $('e_farm').value.trim(),
        phone: $('e_phone').value.trim(),
        ordered: $('e_ordered').checked,
        note: $('e_note').value.trim(),
      };
      const m = validate(upd); if(m){ alert(m); return; }
      state.items[i] = upd; store.save(state.items); render(); closeEdit(); toast('更新しました');
    }

    function toggleOrdered(id, checked){
      const i = state.items.findIndex(x => x.id === id); if(i < 0) return;
      state.items[i].ordered = checked; store.save(state.items); render();
    }

    function wipeAll(){ if(!state.items.length) return; if(confirm('全て削除しますか？')){ state.items = []; store.save(state.items); render(); toast('全削除しました'); } }

    // ===== Init =====
    function populateMonths(select){ for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=`${m}月`; select.appendChild(o); } }

    window.addEventListener('DOMContentLoaded', ()=>{
      // populate months
      populateMonths($('month')); populateMonths($('e_month')); populateMonths($('fMonth'));
      // initial status
      $('storage').textContent = '保存: localStorage';
      $('status').textContent = '準備OK';
      // load
      state.items = store.load(); render();
      // filters
      $('q').addEventListener('input', (e)=>{ state.filters.q = e.target.value; render(); });
      $('fMonth').addEventListener('change', (e)=>{ state.filters.month = e.target.value; render(); });
      $('resetFilters').addEventListener('click', ()=>{ state.filters = { q:'', month:'' }; $('q').value=''; $('fMonth').value=''; render(); });
      // form actions
      $('add').addEventListener('click', add);
      $('wipe').addEventListener('click', wipeAll);
      // edit modal
      $('cancelEdit').addEventListener('click', closeEdit);
      $('saveEdit').addEventListener('click', saveEdit);
      // table delegation
      $('tbody').addEventListener('click', (ev)=>{
        const tr = ev.target.closest('tr[data-id]'); if(!tr) return; const id = tr.getAttribute('data-id');
        if(ev.target.matches('button[data-action="edit"], button') && ev.target.dataset.action === 'edit') openEdit(id);
        else if(ev.target.matches('button[data-action="delete"], button') && ev.target.dataset.action === 'delete') remove(id);
      });
      $('tbody').addEventListener('change', (ev)=>{
        if(ev.target.matches('input[type="checkbox"][data-action="toggle"]')){
          const id = ev.target.closest('tr')?.getAttribute('data-id');
          toggleOrdered(id, ev.target.checked);
        }
      });
    });
  </script>
</body>
</html>
