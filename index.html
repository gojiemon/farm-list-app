<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æœˆåˆ¥ãƒ»è¾²å®¶ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin: 18px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; margin: 6px 0; }
    input, select, textarea, button { padding: 8px; font-size: 14px; }
    input[type="checkbox"] { transform: scale(1.2); }
    textarea { width: 100%; min-height: 60px; }
    .card { border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px; margin: 10px 0; background: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; word-break: break-word; }
    th { background: #f7f7f7; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: #666; font-size: 12px; }
    .danger { color: #b00020; }
    .nowrap { white-space: nowrap; }
    .num { text-align: right; }
  </style>
</head>
<body>
  <h1>ğŸ‡ æœˆåˆ¥ãƒ»è¾²å®¶ãƒªã‚¹ãƒˆ</h1>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <div class="row">
      <input id="year" type="number" placeholder="å¹´ï¼ˆä¾‹ï¼š2025ï¼‰" style="width:120px" />
      <select id="month" style="width:120px">
        <option value="" disabled selected>æœˆã‚’é¸æŠ</option>
        <script>
          // æœˆã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆ1ã€œ12ï¼‰
          for (let m=1; m<=12; m++) {
            document.write(`<option value="${m}">${m}æœˆ</option>`);
          }
        </script>
      </select>
      <input id="fruit" placeholder="æœç‰©åï¼ˆä¾‹ï¼šã‚·ãƒ£ã‚¤ãƒ³ãƒã‚¹ã‚«ãƒƒãƒˆï¼‰" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <input id="farmName" placeholder="è¾²åœ’åï¼ˆå±‹å·ï¼‰" style="flex:1 1 220px" />
      <input id="contactPhone" placeholder="é›»è©±" style="flex:1 1 160px" />
      <input id="contactEmail" placeholder="ãƒ¡ãƒ¼ãƒ«" style="flex:1 1 200px" />
    </div>
    <div class="row">
      <label><input id="ordered" type="checkbox" /> ç™ºæ³¨æ¸ˆã¿ã«ã™ã‚‹</label>
    </div>
    <div class="row">
      <textarea id="note" placeholder="ãƒ¡ãƒ¢ï¼ˆå‘³ãƒ»ç³–åº¦ãƒ»ä¿å­˜ã®ã‚³ãƒ„ãƒ»æ³¨æ„ç‚¹ãªã©ï¼‰"></textarea>
    </div>
    <div class="row">
      <button onclick="addItem()">ç™»éŒ²</button>
      <button onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
      <span class="muted">â€»ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆAPIãªã—ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OKï¼‰</span>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ & æ›¸ãå‡ºã— -->
  <div class="card">
    <div class="controls">
      <input id="filterYear" type="number" placeholder="å¹´ã§çµã‚‹ï¼ˆä¾‹ï¼š2025ï¼‰" oninput="render()" style="width:140px" />
      <select id="filterMonth" onchange="render()" style="width:120px">
        <option value="">æœˆï¼ˆã™ã¹ã¦ï¼‰</option>
        <script>
          for (let m=1; m<=12; m++) {
            document.write(`<option value="${m}">${m}æœˆ</option>`);
          }
        </script>
      </select>
      <input id="keyword" placeholder="æ¤œç´¢ï¼ˆæœç‰©ï¼è¾²åœ’ï¼é€£çµ¡å…ˆï¼ãƒ¡ãƒ¢ï¼‰" oninput="render()" style="flex:1 1 240px" />
      <label class="nowrap"><input id="onlyOrdered" type="checkbox" onchange="render()" /> ç™ºæ³¨æ¸ˆã¿ã®ã¿</label>
      <button onclick="downloadCSV(false)">CSVå‡ºåŠ›ï¼ˆè¡¨ç¤ºä¸­ï¼‰</button>
      <button onclick="downloadCSV(true)">CSVå‡ºåŠ›ï¼ˆå…¨ä»¶ï¼‰</button>
      <button class="danger" onclick="confirmClear()">å…¨å‰Šé™¤</button>
    </div>
  </div>

  <!-- ä¸€è¦§ -->
  <table>
    <thead>
      <tr>
        <th class="num">å¹´</th>
        <th class="num">æœˆ</th>
        <th>æœç‰©å</th>
        <th>è¾²åœ’å</th>
        <th>é€£çµ¡å…ˆï¼ˆé›»è©± / ãƒ¡ãƒ¼ãƒ«ï¼‰</th>
        <th>ç™ºæ³¨</th>
        <th>ãƒ¡ãƒ¢</th>
        <th>å‰Šé™¤</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›ï¼ˆlocalStorageã«ä¿å­˜ï¼‰ ---
    const STORAGE_KEY = "monthly-farmers-v1";
    /** @type {Array<{
      id:string, year:number|null, month:number|null, fruit:string,
      farmName:string, phone:string, email:string, ordered:boolean, note:string,
      createdAt:string
    }>} */
    let items = load();

    function load() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    const $ = (id) => document.getElementById(id);
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const escapeCsv = (s) => {
      const v = (s ?? "").toString().replace(/"/g, '""');
      return /[",\n]/.test(v) ? `"${v}"` : v;
    };

    // --- è¿½åŠ  & è¡¨ç¤º ---
    function addItem() {
      const yearVal = $("year").value.trim();
      const monthVal = $("month").value;
      const year = yearVal ? Number(yearVal) : null;
      const month = monthVal ? Number(monthVal) : null;
      const fruit = $("fruit").value.trim();
      const farmName = $("farmName").value.trim();
      const phone = $("contactPhone").value.trim();
      const email = $("contactEmail").value.trim();
      const ordered = $("ordered").checked;
      const note = $("note").value.trim();

      if (!fruit) { alert("æœç‰©åã¯å¿…é ˆã§ã™"); return; }
      if (!farmName) { alert("è¾²åœ’åã¯å¿…é ˆã§ã™"); return; }
      if (!year) { alert("å¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!month) { alert("æœˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      items.push({
        id: uid(),
        year, month, fruit, farmName, phone, email, ordered, note,
        createdAt: new Date().toISOString()
      });
      save();
      clearForm();
      render();
    }

    function clearForm() {
      // å¹´ãƒ»æœˆã¯æ®‹ã™ï¼ˆé€£ç¶šå…¥åŠ›ãŒæ¥½ï¼‰
      $("fruit").value = "";
      $("farmName").value = "";
      $("contactPhone").value = "";
      $("contactEmail").value = "";
      $("ordered").checked = false;
      $("note").value = "";
    }

    function confirmClear() {
      if (!items.length) return;
      if (confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        items = [];
        save();
        render();
      }
    }

    function render() {
      const yearStr = $("filterYear").value.trim();
      const monthStr = $("filterMonth").value;
      const kw = $("keyword").value.trim().toLowerCase();
      const onlyOrdered = $("onlyOrdered").checked;

      let view = items.slice().sort((a,b) => {
        // å¹´â†“ â†’ æœˆâ†‘ â†’ æœç‰©å ã®é †ã§ä¸¦ã¹ã‚‹
        const ay = a.year ?? -Infinity, by = b.year ?? -Infinity;
        if (ay !== by) return by - ay;
        const am = a.month ?? 0, bm = b.month ?? 0;
        if (am !== bm) return am - bm;
        return a.fruit.localeCompare(b.fruit, "ja");
      });

      if (yearStr) view = view.filter(v => (v.year ?? "") === Number(yearStr));
      if (monthStr) view = view.filter(v => (v.month ?? "") === Number(monthStr));
      if (onlyOrdered) view = view.filter(v => v.ordered);
      if (kw) {
        view = view.filter(v => [
          v.fruit, v.farmName, v.phone, v.email, v.note
        ].some(x => (x || "").toLowerCase().includes(kw)));
      }

      const tbody = $("tbody");
      tbody.innerHTML = "";
      view.forEach((v) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="num">${v.year ?? ""}</td>
          <td class="num">${v.month ?? ""}</td>
          <td>${v.fruit}</td>
          <td>${v.farmName}</td>
          <td>${v.phone || ""}${v.phone && v.email ? " / " : ""}${v.email || ""}</td>
          <td class="nowrap">
            <input type="checkbox" ${v.ordered ? "checked" : ""} onclick="toggleOrdered('${v.id}', this.checked)" />
          </td>
          <td>${v.note || ""}</td>
          <td><button onclick="removeItem('${v.id}')">å‰Šé™¤</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function toggleOrdered(id, checked) {
      const i = items.findIndex(x => x.id === id);
      if (i >= 0) {
        items[i].ordered = checked;
        save();
      }
    }

    function removeItem(id) {
      if (!confirm("ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      items = items.filter(x => x.id !== id);
      save();
      render();
    }

    // --- CSVå‡ºåŠ› ---
    function downloadCSV(all = false) {
      const yearStr = $("filterYear").value.trim();
      const monthStr = $("filterMonth").value;
      const kw = $("keyword").value.trim().toLowerCase();
      const onlyOrdered = $("onlyOrdered").checked;

      let data = items.slice();
      if (!all) {
        if (yearStr) data = data.filter(v => (v.year ?? "") === Number(yearStr));
        if (monthStr) data = data.filter(v => (v.month ?? "") === Number(monthStr));
        if (onlyOrdered) data = data.filter(v => v.ordered);
        if (kw) data = data.filter(v => [
          v.fruit, v.farmName, v.phone, v.email, v.note
        ].some(x => (x || "").toLowerCase().includes(kw)));
      }

      if (!data.length) { alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

      const header = ["å¹´","æœˆ","æœç‰©å","è¾²åœ’å","é›»è©±","ãƒ¡ãƒ¼ãƒ«","ç™ºæ³¨æ¸ˆã¿","ãƒ¡ãƒ¢","ç™»éŒ²æ—¥æ™‚ISO"];
      const rows = data.map(v => [
        v.year ?? "", v.month ?? "", v.fruit, v.farmName, v.phone || "", v.email || "",
        v.ordered ? "TRUE" : "FALSE", v.note || "", v.createdAt
      ].map(escapeCsv).join(","));

      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), {
        href: url,
        download: `monthly-farmers${all ? "-all" : ""}.csv`
      });
      a.click();
      URL.revokeObjectURL(url);
    }

    // åˆæœŸæç”»
    render();
  </script>
</body>
</html>
