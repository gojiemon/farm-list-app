<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>月別・農家リスト（永続保存対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#fff; }
    *{ box-sizing:border-box }
    body { margin:18px; font-family: system-ui, -apple-system, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; color:var(--fg); background:var(--bg); }
    h1 { font-size:20px; margin:0 0 10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; margin:6px 0; }
    input, select, textarea, button { font-size:14px; padding:8px; }
    textarea { width:100%; min-height:60px; }
    button { cursor:pointer; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; margin:10px 0; }
    .bar { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); flex-wrap:wrap; }
    .pill { background:#f3f4f6; border:1px solid var(--line); border-radius:999px; padding:2px 10px; }
    .warning { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
    .tablewrap { max-height:60vh; overflow:auto; border:1px solid var(--line); border-radius:10px; }
    table { width:100%; border-collapse:collapse; }
    thead th { position:sticky; top:0; background:#f8fafc; text-align:left; padding:8px; border-bottom:1px solid var(--line); }
    td { padding:8px; border-bottom:1px solid var(--line); vertical-align:top; }
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:8px; display:none; font-size:12px; }
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { width:min(680px, 92vw); background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:12px; }
    .modal header { font-weight:700; margin-bottom:8px; }
    .modal .footer { display:flex; gap:8px; justify-content:flex-end; }
    @media (max-width:640px){ thead{display:none} table,tbody,tr,td{display:block;width:100%} td{display:flex;gap:8px} td::before{content:attr(data-label);min-width:96px;color:var(--muted)} }
  </style>
</head>
<body>
  <h1>🍇 月別・農家リスト</h1>
  <div class="bar">
    <span id="status" class="pill">準備中…</span>
    <span id="count" class="pill">件数: 0</span>
    <span id="storage" class="pill">保存: 検出中…</span>
    <span id="persist" class="pill">永続化: 検出中…</span>
  </div>

  <div id="warn" class="card warning" style="display:none">この端末では保存が消える可能性があります（プライベートモードや保存ブロック等）。必要に応じて JSON バックアップをご利用ください。</div>

  <div class="card" aria-label="フィルター">
    <div class="row">
      <input id="q" placeholder="果物名・農園名・メモ・電話で検索" style="flex:1 1 260px" />
      <select id="fMonth" style="width:150px"><option value="">すべての月</option></select>
      <button id="resetFilters">リセット</button>
    </div>
  </div>

  <div class="card" aria-label="登録フォーム">
    <div class="row">
      <input id="year" type="number" placeholder="年 (例:2025)" style="width:120px" />
      <select id="month" style="width:120px"></select>
      <input id="fruit" placeholder="果物名" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <input id="farm" placeholder="農園名" style="flex:1 1 220px" />
      <input id="phone" placeholder="電話 (例:090-1234-5678)" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="ordered" /> 発注済み</label>
    </div>
    <div class="row">
      <textarea id="note" placeholder="メモ"></textarea>
    </div>
    <div class="row">
      <button id="add">登録</button>
      <button id="wipe">全削除</button>
      <span style="margin-left:auto"></span>
      <button id="exp">JSONエクスポート</button>
      <label><input type="file" id="imp" accept="application/json" style="display:none"/><button id="impBtn">JSONインポート</button></label>
    </div>
  </div>

  <div class="tablewrap" aria-label="一覧">
    <table>
      <thead><tr>
        <th style="width:70px">月</th>
        <th>果物名</th>
        <th>農園</th>
        <th>電話</th>
        <th style="width:70px">発注</th>
        <th>メモ</th>
        <th style="width:150px">操作</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>行を編集</header>
      <div class="row">
        <input id="e_year" type="number" placeholder="年" style="width:120px" />
        <select id="e_month" style="width:120px"></select>
        <input id="e_fruit" placeholder="果物名" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <input id="e_farm" placeholder="農園名" style="flex:1 1 220px" />
        <input id="e_phone" placeholder="電話" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <label><input type="checkbox" id="e_ordered" /> 発注済み</label>
      </div>
      <div class="row"><textarea id="e_note" placeholder="メモ"></textarea></div>
      <div class="footer">
        <button id="cancelEdit">キャンセル</button>
        <button id="saveEdit">保存</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Storage layer: IndexedDB → fallback localStorage =====
    const DB_NAME = 'mf-db-v1';
    const STORE = 'kv';
    let useIDB = false;
    let db = null;

    function idbOpen(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e)=>{
          const d = req.result; if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE);
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
    }
    function idbGet(key){
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE,'readonly');
        const st = tx.objectStore(STORE);
        const rq = st.get(key);
        rq.onsuccess = ()=> resolve(rq.result ?? null);
        rq.onerror = ()=> reject(rq.error);
      });
    }
    function idbSet(key, val){
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE,'readwrite');
        tx.oncomplete = ()=> resolve();
        tx.onerror = ()=> reject(tx.error);
        tx.objectStore(STORE).put(val, key);
      });
    }

    const store = {
      async init(){
        try{ db = await idbOpen(); useIDB = true; }
        catch{ useIDB = false; }
        $el('storage').textContent = '保存: ' + (useIDB ? 'IndexedDB' : 'localStorage');
      },
      async load(){
        if(useIDB){ try{ return (await idbGet('items')) || []; }catch{ return []; } }
        try{ const raw = localStorage.getItem('mf_items_v1'); return raw ? JSON.parse(raw) : []; }catch{ return []; }
      },
      async save(items){
        if(useIDB){ try{ await idbSet('items', items); return; }catch(e){ console.error(e); } }
        try{ localStorage.setItem('mf_items_v1', JSON.stringify(items)); }catch(e){ console.error(e); }
      }
    };

    // ===== Persistence request (StorageManager) =====
    async function ensurePersistence(){
      let supported = !!(navigator.storage && navigator.storage.persist);
      let persisted = false;
      try{ persisted = supported ? await navigator.storage.persist() : false; }catch{}
      $el('persist').textContent = '永続化: ' + (persisted ? '確保' : (supported ? '未確保' : '非対応'));
      if(!persisted) $el('warn').style.display = 'block';
    }

    // ===== State & utils =====
    const state = { items: [], filters: { q:'', month:'' }, editingId: null };
    const $el = (id)=>document.getElementById(id);
    const telHref = (raw='')=>{ const c=String(raw).replace(/[^+\d]/g,''); return c?`tel:${c}`:'' };
    const toast = (m)=>{ const t=$el('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1800); };
    const setCount = (n)=> $el('count').textContent = `件数: ${n}`;

    // ===== Validation =====
    function validate(p){ if(!p.fruit) return '果物名は必須です'; if(!p.farm) return '農園名は必須です'; if(!p.month) return '月を選択してください'; return '' }

    // ===== Rendering =====
    function rowHTML(v){ const tel=v.phone?`<a href="${telHref(v.phone)}">${v.phone}</a>`:''; return `
      <tr data-id="${v.id}">
        <td data-label="月">${v.month??''}</td>
        <td data-label="果物名">${v.fruit??''}</td>
        <td data-label="農園">${v.farm??''}</td>
        <td data-label="電話">${tel}</td>
        <td data-label="発注"><input type="checkbox" data-action="toggle" ${v.ordered?'checked':''}></td>
        <td data-label="メモ">${(v.note??'').replace(/\n/g,' ')}</td>
        <td data-label="操作"><button data-action="edit">編集</button> <button data-action="delete">削除</button></td>
      </tr>` }

    function applyFilters(items){ let view=items.slice(); if(state.filters.month) view=view.filter(v=>String(v.month)===state.filters.month); if(state.filters.q){ const q=state.filters.q.toLowerCase(); view=view.filter(v=>[v.fruit,v.farm,v.note,v.phone].some(x=>(x||'').toLowerCase().includes(q))); } view.sort((a,b)=> (a.month||0)-(b.month||0) || (a.fruit||'').localeCompare(b.fruit||'', 'ja') || (a.farm||'').localeCompare(b.farm||'', 'ja')); return view }

    function render(){ const view=applyFilters(state.items); const tbody=$el('tbody'); tbody.innerHTML=view.map(rowHTML).join(''); setCount(view.length) }

    // ===== CRUD =====
    async function add(){ const p={ id:crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)+Date.now().toString(36), year:$el('year').value.trim(), month:Number($el('month').value), fruit:$el('fruit').value.trim(), farm:$el('farm').value.trim(), phone:$el('phone').value.trim(), ordered:$el('ordered').checked, note:$el('note').value.trim() }; const m=validate(p); if(m){ alert(m); return; } state.items.push(p); await store.save(state.items); render(); toast('登録しました') }

    async function remove(id){ state.items = state.items.filter(x=>x.id!==id); await store.save(state.items); render(); toast('削除しました') }

    function openEdit(id){ const r=state.items.find(x=>x.id===id); if(!r) return; state.editingId=id; $el('e_year').value=r.year||''; $el('e_month').value=String(r.month||''); $el('e_fruit').value=r.fruit||''; $el('e_farm').value=r.farm||''; $el('e_phone').value=r.phone||''; $el('e_ordered').checked=!!r.ordered; $el('e_note').value=r.note||''; $el('editBackdrop').style.display='flex' }

    async function saveEdit(){ const id=state.editingId; if(!id) return; const i=state.items.findIndex(x=>x.id===id); if(i<0) return; const upd={ ...state.items[i], year:$el('e_year').value.trim(), month:Number($el('e_month').value), fruit:$el('e_fruit').value.trim(), farm:$el('e_farm').value.trim(), phone:$el('e_phone').value.trim(), ordered:$el('e_ordered').checked, note:$el('e_note').value.trim() }; const m=validate(upd); if(m){ alert(m); return; } state.items[i]=upd; await store.save(state.items); render(); closeEdit(); toast('更新しました') }

    function closeEdit(){ state.editingId=null; $el('editBackdrop').style.display='none' }

    async function toggleOrdered(id, ordered){ const idx=state.items.findIndex(x=>x.id===id); if(idx<0) return; state.items[idx]={ ...state.items[idx], ordered }; await store.save(state.items); render(); }

    async function wipeAll(){ if(!state.items.length) return; if(confirm('全て削除しますか？')){ state.items=[]; await store.save(state.items); render(); toast('全削除しました') } }

    // ===== Backup (optional) =====
    function exportJSON(){ const data=JSON.stringify({items:state.items},null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); const url=URL.createObjectURL(blob); a.href=url; a.download='farmer-list-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),0) }
    async function importJSON(ev){ const f=ev.target.files?.[0]; if(!f) return; try{ const txt=await f.text(); const obj=JSON.parse(txt); if(!obj.items||!Array.isArray(obj.items)) throw new Error('形式が不正です'); state.items=obj.items; await store.save(state.items); render(); toast('インポートしました') }catch(e){ alert('読み込みに失敗しました'); console.error(e) } finally { ev.target.value='' }

    // ===== Init =====
    function populateMonths(sel){ for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=`${m}月`; sel.appendChild(o) } }

    window.addEventListener('DOMContentLoaded', async ()=>{
      populateMonths($el('month')); populateMonths($el('e_month')); populateMonths($el('fMonth'));
      $el('storage').textContent = '保存: 検出中…';
      await store.init();
      await ensurePersistence();
      state.items = await store.load();
      render();
      $el('status').textContent='準備OK';
      // filters
      $el('q').addEventListener('input', (e)=>{ state.filters.q=e.target.value; render() });
      $el('fMonth').addEventListener('change', (e)=>{ state.filters.month=e.target.value; render() });
      $el('resetFilters').addEventListener('click', ()=>{ state.filters={q:'',month:''}; $el('q').value=''; $el('fMonth').value=''; render() });
      // form
      $el('add').addEventListener('click', add);
      $el('wipe').addEventListener('click', wipeAll);
      $el('exp').addEventListener('click', exportJSON);
      $el('impBtn').addEventListener('click', ()=> $el('imp').click());
      $el('imp').addEventListener('change', importJSON);
      // table delegation
      $el('tbody').addEventListener('click', (ev)=>{
        const tr=ev.target.closest('tr[data-id]'); if(!tr) return; const id=tr.getAttribute('data-id');
        const act=ev.target.getAttribute('data-action');
        if(act==='edit') openEdit(id);
        if(act==='delete') remove(id);
      });
      $el('tbody').addEventListener('change', (ev)=>{
        if(ev.target.matches('input[type="checkbox"][data-action="toggle"]')){
          const id=ev.target.closest('tr')?.getAttribute('data-id');
          toggleOrdered(id, ev.target.checked);
        }
      });
    });
  </script>
</body>
</html>
