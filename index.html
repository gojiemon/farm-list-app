<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æœˆåˆ¥ãƒ»è¾²å®¶ãƒªã‚¹ãƒˆï¼ˆå®‰å®šç‰ˆãƒ»æ°¸ç¶šä¿å­˜ãƒ»äº’æ›ä¿®æ­£ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#fff; }
    *{ box-sizing:border-box }
    body { margin:18px; font-family: system-ui, -apple-system, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; color:var(--fg); background:var(--bg); }
    h1 { font-size:20px; margin:0 0 10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; margin:6px 0; }
    input, select, textarea, button { font-size:14px; padding:8px; }
    textarea { width:100%; min-height:60px; }
    button { cursor:pointer; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; margin:10px 0; }
    .bar { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); flex-wrap:wrap; }
    .pill { background:#f3f4f6; border:1px solid var(--line); border-radius:999px; padding:2px 10px; }
    .warning { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
    .tablewrap { max-height:60vh; overflow:auto; border:1px solid var(--line); border-radius:10px; }
    /* Card-like table rows */
    table { width:100%; border-collapse:separate; border-spacing:0 10px; }
    thead th { position:sticky; top:0; background:#f8fafc; text-align:left; padding:10px 12px; border-bottom:1px solid var(--line); }
    tbody tr { background:var(--card); border:1px solid var(--accent, var(--line)); border-radius:10px; transition:border-color .15s ease, box-shadow .15s ease; box-shadow: inset 6px 0 0 var(--accent, transparent); }
    tbody tr:hover { border-color:var(--accent, #cbd5e1); box-shadow: inset 6px 0 0 var(--accent, transparent), 0 2px 10px rgba(0,0,0,.06); }
    td { padding:10px 12px; border-bottom:0; vertical-align:top; }
    tbody td:first-child { border-top-left-radius:10px; border-bottom-left-radius:10px; }
    tbody td:last-child  { border-top-right-radius:10px; border-bottom-right-radius:10px; }
    @media (min-width:641px){ tbody td + td { border-left:1px solid var(--line); } }
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:8px; display:none; font-size:12px; }
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { width:min(680px, 92vw); background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:12px; }
    .modal header { font-weight:700; margin-bottom:8px; }
    .modal .footer { display:flex; gap:8px; justify-content:flex-end; }
    @media (max-width:640px){
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{ margin:6px 0 }
      td{display:flex;gap:6px;padding:6px 8px}
      td::before{content:attr(data-label);min-width:80px;color:var(--muted)}
    }
    /* Newly added row flash */
    tbody tr.row-new { border-color:#60a5fa !important; box-shadow:0 0 0 2px rgba(96,165,250,.25), 0 2px 10px rgba(0,0,0,.06); }
  </style>
</head>
<body>
  <h1>ğŸ‡ æœˆåˆ¥ãƒ»è¾²å®¶ãƒªã‚¹ãƒˆ</h1>
  <div class="bar">
    <span id="status" class="pill">æº–å‚™ä¸­â€¦</span>
    <span id="count" class="pill">ä»¶æ•°: 0</span>
    <span id="storage" class="pill">ä¿å­˜: æ¤œå‡ºä¸­â€¦</span>
    <span id="persist" class="pill">æ°¸ç¶šåŒ–: æ¤œå‡ºä¸­â€¦</span>
  </div>

  <div id="warn" class="card warning" style="display:none">ã“ã®ç«¯æœ«ã§ã¯ä¿å­˜ãŒæ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚„ä¿å­˜ãƒ–ãƒ­ãƒƒã‚¯ç­‰ï¼‰ã€‚å¿…è¦ã«å¿œã˜ã¦ JSON ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>

  <!-- Filters -->
  <div class="card" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
    <div class="row">
      <input id="q" placeholder="æœç‰©åãƒ»è¾²åœ’åãƒ»ãƒ¡ãƒ¢ãƒ»é›»è©±ã§æ¤œç´¢" style="flex:1 1 260px" />
      <select id="fMonth" style="width:150px"><option value="">ã™ã¹ã¦ã®æœˆ</option></select>
      <button id="resetFilters">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- Form -->
  <div class="card" aria-label="ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ">
    <div class="row">
      <input id="year" type="number" placeholder="å¹´ (ä¾‹:2025)" style="width:120px" />
      <select id="month" style="width:120px"></select>
      <input id="fruit" placeholder="æœç‰©å" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <input id="farm" placeholder="è¾²åœ’å" style="flex:1 1 220px" />
      <input id="phone" placeholder="é›»è©± (ä¾‹:090-1234-5678)" style="flex:1 1 220px" />
    </div>
    <div class="row">
      <input id="address" placeholder="ä½æ‰€" style="flex:1 1 460px" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="ordered" /> ç™ºæ³¨æ¸ˆã¿</label>
    </div>
    <div class="row">
      <textarea id="note" placeholder="ãƒ¡ãƒ¢"></textarea>
    </div>
    <div class="row">
      <button id="add">ç™»éŒ²</button>
      <button id="wipe">å…¨å‰Šé™¤</button>
      <span style="margin-left:auto"></span>
      <button id="exp">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label><input type="file" id="imp" accept="application/json" style="display:none"/><button id="impBtn" type="button">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button></label>
    </div>
  </div>

  <!-- List -->
  <div class="tablewrap" aria-label="ä¸€è¦§">
    <table>
      <thead><tr>
        <th style="width:70px">æœˆ</th>
        <th>æœç‰©å</th>
        <th>è¾²åœ’</th>
        <th>ä½æ‰€</th>
        <th>é›»è©±</th>
        <th style="width:70px">ç™ºæ³¨</th>
        <th>ãƒ¡ãƒ¢</th>
        <th style="width:150px">æ“ä½œ</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Edit Modal -->
  <div id="editBackdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header>è¡Œã‚’ç·¨é›†</header>
      <div class="row">
        <input id="e_year" type="number" placeholder="å¹´" style="width:120px" />
        <select id="e_month" style="width:120px"></select>
        <input id="e_fruit" placeholder="æœç‰©å" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <input id="e_farm" placeholder="è¾²åœ’å" style="flex:1 1 220px" />
        <input id="e_phone" placeholder="é›»è©±" style="flex:1 1 220px" />
      </div>
      <div class="row">
        <input id="e_address" placeholder="ä½æ‰€" style="flex:1 1 460px" />
      </div>
      <div class="row">
        <label><input type="checkbox" id="e_ordered" /> ç™ºæ³¨æ¸ˆã¿</label>
      </div>
      <div class="row"><textarea id="e_note" placeholder="ãƒ¡ãƒ¢"></textarea></div>
      <div class="footer">
        <button id="cancelEdit" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="saveEdit" type="button">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Storage layer: IndexedDB â†’ fallback localStorage =====
    const DB_NAME = 'mf-db-v1';
    const STORE = 'kv';
    var useIDB = false;
    var db = null;

    function idbOpen(){
      return new Promise(function(resolve, reject){
        var req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = function(){
          var d = req.result; if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE);
        };
        req.onsuccess = function(){ resolve(req.result); };
        req.onerror = function(){ reject(req.error); };
      });
    }
    function idbGet(key){
      return new Promise(function(resolve,reject){
        var tx = db.transaction(STORE,'readonly');
        var st = tx.objectStore(STORE);
        var rq = st.get(key);
        rq.onsuccess = function(){ resolve(rq.result != null ? rq.result : null); };
        rq.onerror = function(){ reject(rq.error); };
      });
    }
    function idbSet(key, val){
      return new Promise(function(resolve,reject){
        var tx = db.transaction(STORE,'readwrite');
        tx.oncomplete = function(){ resolve(); };
        tx.onerror = function(){ reject(tx.error); };
        tx.objectStore(STORE).put(val, key);
      });
    }

    var store = {
      init: async function(){
        try{ db = await idbOpen(); useIDB = true; }
        catch(e){ useIDB = false; }
        document.getElementById('storage').textContent = 'ä¿å­˜: ' + (useIDB ? 'IndexedDB' : 'localStorage');
      },
      load: async function(){
        if(useIDB){ try{ return (await idbGet('items')) || []; }catch(e){ return []; } }
        try{ var raw = localStorage.getItem('mf_items_v1'); return raw ? JSON.parse(raw) : []; }catch(e){ return []; }
      },
      save: async function(items){
        if(useIDB){ try{ await idbSet('items', items); return; }catch(e){ console.error(e); } }
        try{ localStorage.setItem('mf_items_v1', JSON.stringify(items)); }catch(e){ console.error(e); }
      }
    };

    // ===== Persistence request (StorageManager) =====
    async function ensurePersistence(){
      var supported = !!(navigator.storage && navigator.storage.persist);
      var persisted = false;
      try{ persisted = supported ? await navigator.storage.persist() : false; }catch(e){}
      document.getElementById('persist').textContent = 'æ°¸ç¶šåŒ–: ' + (persisted ? 'ç¢ºä¿' : (supported ? 'æœªç¢ºä¿' : 'éå¯¾å¿œ'));
      if(!persisted) document.getElementById('warn').style.display = 'block';
    }

    // ===== State & utils =====
    var state = { items: [], filters: { q:'', month:'' }, editingId: null };
    function $(id){ return document.getElementById(id); }
    // ID generator (same policy as add())
    function genId(){
      var id=null; try{ id=(window.crypto&&crypto.randomUUID)?crypto.randomUUID():null; }catch(e){ id=null; }
      if(!id) id = Math.random().toString(36).slice(2)+Date.now().toString(36);
      return id;
    }
    function telHref(raw){ var c=String(raw||'').replace(/[^+\d]/g,''); return c?('tel:'+c):'' }
    function toast(m){ var t=$('toast'); t.textContent=m; t.style.display='block'; setTimeout(function(){ t.style.display='none'; },1800); }
    function setCount(n){ $('count').textContent = 'ä»¶æ•°: ' + n; }
    // åˆæœŸç™»éŒ²ç”¨ï¼ˆä¿å­˜ãŒç©ºã®ã¨ãä¸€åº¦ã ã‘æŠ•å…¥ï¼‰
    var DEFAULT_ITEMS = [
      { id: genId(), year:'', month:4, fruit:'ã„ã¡ã”', farm:'ç§‹å±±è¾²åœ’ï¼ˆå±±å½¢ãƒ»é…’ç”°ï¼‰', phone:'', ordered:false, note:'å®‰å€ã•ã‚“ã®ç´¹ä»‹' },
      { id: genId(), year:'', month:6, fruit:'ã‚ã‚“ãš', farm:'ã‚„ã¾ã•è¾²åœ’', phone:'', ordered:false, note:'å“ç¨®: ãƒãƒ¼ã‚³ãƒƒãƒˆ' },
      { id: genId(), year:'', month:6, fruit:'æ¡ƒ',   farm:'æ‰å±±è¾²åœ’', phone:'', ordered:false, note:'ã‚¢ã‚°ãƒªãƒ¬ãƒ¼ãƒ™ãƒ³ æ–‰è—¤ã•ã‚“ã®ç´¹ä»‹' },
      { id: genId(), year:'', month:7, fruit:'ãƒ¡ãƒ­ãƒ³', farm:'ç§‹å±±è¾²åœ’ï¼ˆå±±å½¢ãƒ»é…’ç”°ï¼‰', phone:'', ordered:false, note:'å®‰å€ã•ã‚“ç´¹ä»‹' },
      { id: genId(), year:'', month:9, fruit:'ã¶ã©ã†', farm:'å°é‡è¾²åœ’ï¼ˆå±±æ¢¨ã®ç‰§å²¡ï¼‰', phone:'', ordered:false, note:'å“ç¨®: å·¨å³° / BKã‚·ãƒ¼ãƒ‰ãƒ¬ã‚¹ / ãƒã‚¹ã‚«ãƒƒãƒˆç³»' },
      { id: genId(), year:'', month:9, fruit:'ã¶ã©ã†', farm:'å¹³è³€ è‘¡è„åœ’', phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:9, fruit:'ã¶ã©ã†', farm:'ã‚¢ã‚°ãƒªãƒ¬ãƒ¼ãƒ™ãƒ³ æ–‰è—¤ã•ã‚“', phone:'', ordered:false, note:'å“ç¨®: ã‚·ãƒ£ã‚¤ãƒ³ãƒã‚¹ã‚«ãƒƒãƒˆ / å·¨å³° / ã‚«ã‚¤ã‚­ãƒ³ã‚°ã€‚ç´¹ä»‹: äº”æœˆå¥³ã•ã‚“' },
      { id: genId(), year:'', month:9, fruit:'æ¢¨',   farm:'äº”ååµè¾²åœ’ï¼ˆå±±å½¢ãƒ»å‚ç”°ï¼‰', phone:'', ordered:false, note:'å“ç¨®: è±Šæ°´ / å—æ°´ã€‚é˜¿éƒ¨ã•ã‚“ç´¹ä»‹' },
      { id: genId(), year:'', month:10, fruit:'ã•ã¤ã¾ã„ã‚‚', farm:'ã‚µãƒ³ã‚µãƒ³ãƒ•ã‚¡ãƒ¼ãƒ  é˜¿éƒ¨ï¼ˆå±±å½¢ãƒ»é…’ç”°ï¼‰', phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:11, fruit:'ã¿ã‹ã‚“', farm:'ã“ãŸã¤ãƒ•ã‚¡ãƒ¼ãƒ ', phone:'', ordered:false, note:'å“ç¨®: ã›ã¨ã‹ / æ´¥ã®è¼' },
      { id: genId(), year:'', month:12, fruit:'ã„ã¡ã”', farm:'é§’ãƒ¶æ ¹ã„ã¡ã”åœ’', phone:'', ordered:false, note:'å“ç¨®: ç´…ã»ã£ãº' }
      // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ¬ãƒƒãƒ‰ã‚­ã‚¦ã‚¤ï¼ˆã½ã½è¾²åœ’ é«˜æ©‹ï¼‰ã¯æœˆãŒæœªç¢ºå®šã®ãŸã‚ä¿ç•™ã€‚æœˆã‚’ã”æŒ‡å®šãã ã•ã„ã€‚
    ];
    // è¾²åœ’åã‹ã‚‰å®‰å®šã—ãŸè‰²(HSL)ã‚’ç”Ÿæˆ
    // è¿½åŠ ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ï¼‰
    var DEFAULT_EXTRA = [
      { id: genId(), year:'', month:10, fruit:'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ¬ãƒƒãƒ‰ã‚­ã‚¦ã‚¤', farm:'ã½ã½è¾²åœ’ é«˜æ©‹', phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:5,  fruit:'ãƒ”ãƒ¼ãƒãƒ‘ã‚¤ãƒ³',           farm:'ã‚„ã¾ã­ã“è¾²åœ’',           phone:'0980-85-6366', ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'æ¢…',                     farm:'ä¸­æ¾æ¢…åœ’',               phone:'090-5881-3391', ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'ã‚µãƒ¯ãƒ¼ãƒã‚§ãƒªãƒ¼',         farm:'ã‚„ã¾ã•è¾²åœ’',             phone:'090-381-2609', ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'ã‚µã‚¯ãƒ©ãƒ³ãƒœ',             farm:'ä»Šç”°è¾²åœ’',               phone:'090-4657-2418', ordered:false, note:'' },
      { id: genId(), year:'', month:7,  fruit:'ã‚µã‚¯ãƒ©ãƒ³ãƒœ',             farm:'ä»Šç”°è¾²åœ’',               phone:'090-4657-2418', ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'å…«ãƒ¶å²³ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼',     farm:'å…«ãƒ¶å²³ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼çµ„åˆ', phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'ãƒ—ãƒ©ãƒ ',                 farm:'bonch',                  phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'æ¡‘ã®è‘‰',                 farm:'æ ªå¼ä¼šç¤¾ æ¡‘ã®é‡Œ',         phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:6,  fruit:'ãƒ¡ãƒ­ãƒ³',                 farm:'è…ç”Ÿè¾²åœ’',               phone:'0479573521',   ordered:false, note:'å“ç¨®: ã‚¿ã‚«ãƒŸãƒ¡ãƒ­ãƒ³' },
      { id: genId(), year:'', month:6,  fruit:'ãƒã‚¹ã‚«ãƒƒãƒ—',             farm:'ä¸­è¥¿ãƒ•ã‚¡ãƒ¼ãƒ ',           phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:7,  fruit:'ãƒã‚¹ã‚«ãƒƒãƒ—',             farm:'ä¸­è¥¿ãƒ•ã‚¡ãƒ¼ãƒ ',           phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:7,  fruit:'ã‚¹ã‚¤ã‚«',                 farm:'å¤§äº•è¾²åœ’',               phone:'',             ordered:false, note:'é›»è©±ç•ªå·ã®ç¢ºèªãŒå¿…è¦' }
    ];
    var DEFAULT_MORE = [
      { id: genId(), year:'', month:7,  fruit:'æ²–ç¸„ãƒãƒ³ã‚´ãƒ¼',   farm:'ãŸã‹ã™ã˜ãƒãƒ³ã‚´ãƒ¼åœ’', phone:'098-968-5373', ordered:false, note:'äºˆå‚™: 090-4471-8225' },
      { id: genId(), year:'', month:6,  fruit:'ãƒã‚¯ã‚¿ãƒªãƒ³',     farm:'ãƒ•ãƒ«ãƒ¼ãƒ„å·¥æˆ¿ã‚¿ãƒ³ã‚¶ãƒ¯', phone:'090-4958-9737', ordered:false, note:'' },
      { id: genId(), year:'', month:7,  fruit:'å…«ãƒ¶å²³ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼', farm:'ã‚¦ãƒƒãƒ‰ãƒ™ãƒªãƒ¼ã‚ºè¾²åœ’', phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:7,  fruit:'ã„ã¡ã˜ã',       farm:'å®®å†…è¾²åœ’',           phone:'090-5376-6942', ordered:false, note:'' },
      { id: genId(), year:'', month:8,  fruit:'ç”Ÿãƒˆã‚¦ãƒ¢ãƒ­ã‚³ã‚·', farm:'ãƒãƒãƒ©ãƒãƒ¼ã‚¨ãƒ³ æŸ³æ²¢', phone:'080-5145-0396', ordered:false, note:'' },
      { id: genId(), year:'', month:9,  fruit:'ã¶ã©ã†',         farm:'ä¸­æ‘è¾²åœ’',           phone:'090-1502-6246', ordered:false, note:'å“ç¨®: å·¨å³° / ãƒŠã‚¬ãƒãƒ‘ãƒ¼ãƒ—ãƒ« / ã‚·ãƒ£ã‚¤ãƒ³ãƒã‚¹ã‚«ãƒƒãƒˆ' },
      { id: genId(), year:'', month:9,  fruit:'æ¢¨',             farm:'åŸ ã‚Šã‚“ã”åœ’',       phone:'090-1868-3182', ordered:false, note:'å“ç¨®: å—æ°´' },
      { id: genId(), year:'', month:9,  fruit:'ãƒ–ãƒ©ãƒ ãƒªãƒ¼ã‚¢ãƒƒãƒ—ãƒ«', farm:'ã‚„ã¾ã•è¾²åœ’',     phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:9,  fruit:'ã™ã ã¡',         farm:'é‡Œå±±ã¿ã‚‰ã„',         phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:9,  fruit:'ã„ã¡ã˜ã',       farm:'ã‚„ã¾ã­åœ’',           phone:'090-2530-5999', ordered:false, note:'å“ç¨®: ãƒãƒŠãƒ¼ãƒ / ãƒãƒ“ã‚ªãƒ¬ã‚½ãƒªã‚¨ã‚¹' },
      { id: genId(), year:'', month:9,  fruit:'ã„ã¡ã˜ã',       farm:'è˜åŸœåœ’',             phone:'', ordered:false, note:'å“ç¨®: ãƒãƒŠãƒ¼ãƒ' },
      { id: genId(), year:'', month:9,  fruit:'ãƒ—ãƒ«ãƒ¼ãƒ³',       farm:'é•·ç”°è¾²åœ’',           phone:'090-2259-1388', ordered:false, note:'' },
      { id: genId(), year:'', month:10, fruit:'ãƒ˜ãƒ™ã‚¹',         farm:'é»’æœ¨è¾²åœ’',           phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:10, fruit:'ãƒ©ã‚¤ãƒ ',         farm:'ã‚¦ã‚©ãƒ¼ãƒãƒ£ãƒ¼ãƒ‰ã‚¢ã‚°ãƒª ã‚«ãƒ«ãƒãƒ£ãƒ¼ãƒ•ã‚¡ãƒ¼ãƒãƒ¼', phone:'', ordered:false, note:'' },
      { id: genId(), year:'', month:10, fruit:'æ´‹æ¢¨',           farm:'é–¢è¾²åœ’',             phone:'090-668-4776', ordered:false, note:'å“ç¨®: ãƒãƒ©ãƒ¼ãƒ‰ / ãƒ©ãƒ»ãƒ•ãƒ©ãƒ³ã‚¹' },
      { id: genId(), year:'', month:11, fruit:'å¯Œæœ‰æŸ¿',         farm:'å±±æœ¬è¾²åœ’',           phone:'',             ordered:false, note:'' },
      { id: genId(), year:'', month:11, fruit:'æŸ¿',             farm:'è˜åŸœåœ’',             phone:'090-3400-6649', ordered:false, note:'å“ç¨®: æ¬¡éƒæŸ¿ / æ±äº¬ç´…' },
      { id: genId(), year:'', month:11, fruit:'ã¿ã‹ã‚“',         farm:'æ—©æ´¥ã¿ã‹ã‚“åœ’',       phone:'090-9720-6889', ordered:false, note:'å“ç¨®: ãŠã²ã•ã¾ã‚ªãƒ¬ãƒ³ã‚¸' },
      { id: genId(), year:'', month:11, fruit:'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ¬ãƒƒãƒ‰ã‚­ã‚¦ã‚¤', farm:'è¼ã‚‰ã‚Šæœæ¨¹åœ’',     phone:'090-7543-3100', ordered:false, note:'å…¥è·äºˆå®š: 11/9' },
      { id: genId(), year:'', month:1,  fruit:'é‡‘æŸ‘',           farm:'å†…å±±é‡‘æŸ‘åœ’',         phone:'080-6414-6811', ordered:false, note:'' }
      // æœˆæœªå®š: ãƒ—ãƒ©ãƒ  / æ‰å±±è¾²åœ’ï¼ˆã”æŒ‡å®šãã ã•ã„ï¼‰
    ];
    function accentFromFarm(name){
      var s=String(name||''); var h=0>>>0; for(var i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; }
      var hue=h%360; var sat=70; var light=55;
      return 'hsl('+hue+', '+sat+'%, '+light+'%)';
    }

    // ===== Validation =====
    function validate(p){ if(!p.fruit) return 'æœç‰©åã¯å¿…é ˆã§ã™'; if(!p.farm) return 'è¾²åœ’åã¯å¿…é ˆã§ã™'; if(!p.month) return 'æœˆã‚’é¸æŠã—ã¦ãã ã•ã„'; return '' }
    // åˆæœŸã‚·ãƒ¼ãƒ‰å¾Œã®è£œæ­£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºï¼‰
    function applySeedCorrections(list){
      try{
        // 7æœˆã®ã‚µã‚¯ãƒ©ãƒ³ãƒœï¼ˆä»Šç”°è¾²åœ’ï¼‰ã¯å‰Šé™¤ã—ã€6æœˆã®ã¿æ®‹ã™
        list = list.filter(function(x){
          var isTarget = String(x.fruit||'').indexOf('ã‚µã‚¯ãƒ©ãƒ³ãƒœ') !== -1 && String(x.farm||'').indexOf('ä»Šç”°') !== -1 && Number(x.month) === 7;
          return !isTarget;
        });
        // å¤§äº•è¾²åœ’ï¼ˆã‚¹ã‚¤ã‚«ï¼‰ã®é›»è©±ç•ªå·ã‚’ 090-2545-5206 ã«è£œæ­£
        list.forEach(function(x){
          if(String(x.fruit||'')==='ã‚¹ã‚¤ã‚«' && String(x.farm||'').indexOf('å¤§äº•è¾²åœ’')!==-1){ x.phone = '090-2545-5206'; }
        });
      }catch(e){}
      return list;
    }

    // ===== Rendering =====
    function rowHTML(v){ var tel=v.phone?('<a href="'+telHref(v.phone)+'">'+v.phone+'</a>'):''; var acc=accentFromFarm(v.farm); return (
      '<tr data-id="'+v.id+'" style="--accent:'+acc+'">\n'
      +'  <td data-label="æœˆ">'+(v.month!=null?v.month:'')+'</td>\n'
      +'  <td data-label="æœç‰©å">'+(v.fruit!=null?v.fruit:'')+'</td>\n'
      +'  <td data-label="è¾²åœ’">'+(v.farm!=null?v.farm:'')+'</td>\n'
      +'  <td data-label="ä½æ‰€">'+(v.address!=null?v.address:'')+'</td>\n'
      +'  <td data-label="é›»è©±">'+tel+'</td>\n'
      +'  <td data-label="ç™ºæ³¨"><input type="checkbox" data-action="toggle" '+(v.ordered?'checked':'')+'></td>\n'
      +'  <td data-label="ãƒ¡ãƒ¢">'+String(v.note!=null?v.note:'').replace(/\n/g,' ')+'</td>\n'
      +'  <td data-label="æ“ä½œ"><button data-action="edit" type="button">ç·¨é›†</button> <button data-action="delete" type="button">å‰Šé™¤</button></td>\n'
      +'</tr>' ); }

    function applyFilters(items){
      var view = items.slice();
      if(state.filters.month) view = view.filter(function(v){ return String(v.month)===state.filters.month; });
      if(state.filters.q){ var q=String(state.filters.q||'').toLowerCase(); view = view.filter(function(v){ return [v.fruit,v.farm,v.address,v.note,v.phone].some(function(x){ return String(x||'').toLowerCase().indexOf(q) !== -1; }); }); }
      view.sort(function(a,b){ return (a.month||0)-(b.month||0) || String(a.fruit||'').localeCompare(String(b.fruit||''),'ja') || String(a.farm||'').localeCompare(String(b.farm||''),'ja'); });
      return view;
    }

    function render(){ var view=applyFilters(state.items); var tbody=$('tbody'); tbody.innerHTML=view.map(rowHTML).join(''); setCount(view.length); }
    function highlightRow(id){ try{ var tr=document.querySelector('tbody tr[data-id="'+id+'"]'); if(tr){ tr.classList.add('row-new'); tr.scrollIntoView({block:'nearest', behavior:'smooth'}); setTimeout(function(){ tr.classList.remove('row-new'); },1400); } }catch(e){} }

    // ===== CRUD =====
    async function add(){
      var id;
      try{ id = (window.crypto&&crypto.randomUUID)?crypto.randomUUID():null; }catch(e){ id=null; }
      if(!id) id = Math.random().toString(36).slice(2)+Date.now().toString(36);
      var p={
        id:id,
        year:String($('year').value||'').trim(),
        month:Number($('month').value),
        fruit:String($('fruit').value||'').trim(),
        farm:String($('farm').value||'').trim(),
        phone:String($('phone').value||'').trim(),
        address:String($('address').value||'').trim(),
        ordered: !!$('ordered').checked,
        note:String($('note').value||'').trim()
      };
      var m=validate(p); if(m){ alert(m); return; }
      state.items.push(p); await store.save(state.items); render(); highlightRow(id); toast('ç™»éŒ²ã—ã¾ã—ãŸ');
    }

    async function remove(id){ state.items = state.items.filter(function(x){ return x.id!==id; }); await store.save(state.items); render(); toast('å‰Šé™¤ã—ã¾ã—ãŸ'); }

    function openEdit(id){ var r=state.items.find(function(x){ return x.id===id; }); if(!r) return; state.editingId=id; $('e_year').value=r.year||''; $('e_month').value=String(r.month||''); $('e_fruit').value=r.fruit||''; $('e_farm').value=r.farm||''; $('e_phone').value=r.phone||''; $('e_address').value=r.address||''; $('e_ordered').checked=!!r.ordered; $('e_note').value=r.note||''; $('editBackdrop').style.display='flex'; }

    async function saveEdit(){ var id=state.editingId; if(!id) return; var i=state.items.findIndex(function(x){ return x.id===id; }); if(i<0) return; var upd={
        id: state.items[i].id,
        year:String($('e_year').value||'').trim(),
        month:Number($('e_month').value),
        fruit:String($('e_fruit').value||'').trim(),
        farm:String($('e_farm').value||'').trim(),
        phone:String($('e_phone').value||'').trim(),
        address:String($('e_address').value||'').trim(),
        ordered: !!$('e_ordered').checked,
        note:String($('e_note').value||'').trim()
      };
      var m=validate(upd); if(m){ alert(m); return; }
      state.items[i]=upd; await store.save(state.items); render(); closeEdit(); toast('æ›´æ–°ã—ã¾ã—ãŸ');
    }

    function closeEdit(){ state.editingId=null; $('editBackdrop').style.display='none'; }

    function toggleOrdered(id, checked){
      var i = state.items.findIndex(function(x){ return x.id===id; });
      if(i<0) return;
      state.items[i].ordered = !!checked;
      store.save(state.items).then(function(){ render(); });
    }

    async function wipeAll(){ if(!state.items.length) return; if(confirm('å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ state.items=[]; await store.save(state.items); render(); toast('å…¨å‰Šé™¤ã—ã¾ã—ãŸ'); } }

    // ===== Backup (optional) =====
    function exportJSON(){ var data=JSON.stringify({items:state.items},null,2); var blob=new Blob([data],{type:'application/json'}); var a=document.createElement('a'); var url=URL.createObjectURL(blob); a.href=url; a.download='farmer-list-backup.json'; a.click(); setTimeout(function(){ URL.revokeObjectURL(url); },0); }
    async function importJSON(ev){ var f=ev.target.files&&ev.target.files[0]; if(!f) return; try{ var txt=await f.text(); var obj=JSON.parse(txt); if(!obj.items||!Array.isArray(obj.items)) throw new Error('å½¢å¼ãŒä¸æ­£ã§ã™'); state.items=obj.items; await store.save(state.items); render(); toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); console.error(e); } finally { ev.target.value=''; } }

    // ===== Month Selects =====
    function populateMonthsForm(sel){ if(!sel) return; sel.innerHTML=''; var cur=(new Date()).getMonth()+1; for(var m=1;m<=12;m++){ var o=document.createElement('option'); o.value=m; o.textContent=m+'æœˆ'; if(m===cur) o.selected=true; sel.appendChild(o);} }
    function populateMonthsEdit(sel){ if(!sel) return; sel.innerHTML=''; for(var m=1;m<=12;m++){ var o=document.createElement('option'); o.value=m; o.textContent=m+'æœˆ'; sel.appendChild(o);} }
    function populateMonthsFilter(sel){ if(!sel) return; sel.innerHTML=''; var any=document.createElement('option'); any.value=''; any.textContent='ã™ã¹ã¦ã®æœˆ'; sel.appendChild(any); for(var m=1;m<=12;m++){ var o=document.createElement('option'); o.value=m; o.textContent=m+'æœˆ'; sel.appendChild(o);} }

    // ===== Sanity tests (non-destructive) =====
    function sanityTests(){
      try{
        console.assert(document.getElementById('month').options.length>=12, 'month options missing');
        console.assert(document.getElementById('tbody'), 'tbody missing');
        console.log('[sanity] OK');
      }catch(e){ console.warn('[sanity] failed', e); }
    }

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', async function(){
      // months
      populateMonthsForm(document.getElementById('month'));
      populateMonthsEdit(document.getElementById('e_month'));
      populateMonthsFilter(document.getElementById('fMonth'));
      ['month','e_month','fMonth'].forEach(function(id){ var s=document.getElementById(id); if(s) s.addEventListener('focus', function(){ if(!s.options.length){ if(id==='month') populateMonthsForm(s); else if(id==='e_month') populateMonthsEdit(s); else populateMonthsFilter(s); } }); });

      // storage & persistence
      await store.init();
      await ensurePersistence();

      // load & seed if empty, then render
      state.items = await store.load();
      if(!state.items || !state.items.length){
        state.items = DEFAULT_ITEMS.concat(DEFAULT_EXTRA, DEFAULT_MORE);
        state.items = applySeedCorrections(state.items);
        await store.save(state.items);
      }
      render();
      document.getElementById('status').textContent='æº–å‚™OK';

      // filters
      document.getElementById('q').addEventListener('input', function(e){ state.filters.q=e.target.value; render(); });
      document.getElementById('fMonth').addEventListener('change', function(e){ state.filters.month=e.target.value; render(); });
      document.getElementById('resetFilters').addEventListener('click', function(){ state.filters={q:'',month:''}; document.getElementById('q').value=''; document.getElementById('fMonth').value=''; render(); });

      // form
      document.getElementById('add').addEventListener('click', add);
      document.getElementById('wipe').addEventListener('click', wipeAll);
      document.getElementById('exp').addEventListener('click', exportJSON);
      document.getElementById('impBtn').addEventListener('click', function(){ document.getElementById('imp').click(); });
      document.getElementById('imp').addEventListener('change', importJSON);

      // modal buttons
      document.getElementById('cancelEdit').addEventListener('click', function(){ closeEdit(); });
      document.getElementById('saveEdit').addEventListener('click', function(){ saveEdit(); });
      // close on backdrop click
      document.getElementById('editBackdrop').addEventListener('click', function(ev){ if (ev.target === this) { closeEdit(); } });
      // close on ESC key
      document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape' || ev.keyCode === 27){ closeEdit(); } });

      // table delegation
      document.getElementById('tbody').addEventListener('click', function(ev){
        var tr=ev.target.closest('tr'); if(!tr) return; var id=tr.getAttribute('data-id');
        var btn=ev.target.closest('button[data-action]');
        if(btn){ var act=btn.getAttribute('data-action'); if(act==='edit') openEdit(id); if(act==='delete') remove(id); }
      });
      document.getElementById('tbody').addEventListener('change', function(ev){
        if(ev.target && ev.target.tagName==='INPUT' && ev.target.type==='checkbox' && ev.target.getAttribute('data-action')==='toggle'){
          var tr=ev.target.closest('tr'); var id=tr?tr.getAttribute('data-id'):null; if(id) toggleOrdered(id, ev.target.checked);
        }
      });

      sanityTests();
    });
  </script>
</body>
</html>
